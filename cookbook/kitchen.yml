---
# https://us-east-1.console.aws.amazon.com/ec2/home?region=us-east-1#Home:
suites:
  - name: default
    transport:
      ssh_key: keys/jon_test.pem
      username: ec2-user
    driver:
      name: ec2
      region: us-east-1
      instance_type: t3.micro
      associate_public_ip: true
      # https://us-east-1.console.aws.amazon.com/ec2/home?region=us-east-1#KeyPairs:
      aws_ssh_key_id: jon_test
      # https://us-east-1.console.aws.amazon.com/ec2/home?region=us-east-1#SecurityGroups:
      security_group_ids: ['sg-07a2d1eb0e54c34c5']
      # https://us-east-1.console.aws.amazon.com/vpcconsole/home?region=us-east-1#subnets:
      subnet_id: subnet-09b5e80a62cfe2253
      # https://us-east-1.console.aws.amazon.com/ec2/home?region=us-east-1#AMICatalog:
      image_id: ami-0b112ae24c8e415a5

verifier:
  name: inspec
  sudo: true
  reporter:
    - cli
    - json:spec/results/%{platform}_%{suite}.json
  inspec_tests:
    - name: rhel9
      git: https://github.com/mitre/redhat-enterprise-linux-9-stig-baseline.git
  controls:
  - SV-257779 #RHEL 9 must display the Standard Mandatory DOD Notice and Consent Banner before granting local or remote access to the system via a command line user logon. (1 failed)
  - SV-257780 #RHEL 9 must implement the Endpoint Security for Linux Threat Prevention tool. (2 failed)
  - SV-257787 #RHEL 9 must require a boot loader superuser password. (1 failed)
  - SV-257789 #RHEL 9 must require a unique superusers name upon booting into single-user and maintenance modes. (1 failed)
  - SV-257803 #RHEL 9 must disable the kernel.core_pattern. (1 failed)
  - SV-257811 #RHEL 9 must restrict usage of ptrace to descendant processes. (3 failed)
  - SV-257812 #RHEL 9 must disable core dump backtraces.
  - SV-257814 #RHEL 9 must disable core dumps for all users. (1 failed)
  - SV-257818 #The kdump service on RHEL 9 must be disabled. (3 failed)
  - SV-257821 #RHEL 9 must check the GPG signature of locally installed software packages before installation.
  - SV-257828 #RHEL 9 must not have the nfs-utils package installed.
  - SV-257832 #RHEL 9 must not have the gssproxy package installed.
  - SV-257834 #RHEL 9 must not have the tuned package installed.
  - SV-257841 #RHEL 9 must have the rng-tools package installed.
  - SV-257842 #RHEL 9 must have the s-nail package installed.
  - SV-257843 #A separate RHEL 9 file system must be used for user home directories (such as /home or an equivalent). (1 failed)
  - SV-257844 #RHEL 9 must use a separate file system for /tmp. (2 failed)
  - SV-257845 #RHEL 9 must use a separate file system for /var. (2 failed)
  - SV-257846 #RHEL 9 must use a separate file system for /var/log. (2 failed)
  - SV-257847 #RHEL 9 must use a separate file system for the system audit data path. (2 failed)
  - SV-257848 #RHEL 9 must use a separate file system for /var/tmp. (2 failed)
  - SV-257850 #RHEL 9 must prevent device files from being interpreted on file systems that contain user home directories. (1 failed)
  - SV-257851 #RHEL 9 must prevent files with the setuid and setgid bit set from being executed on file systems that contain user home directories. (1 failed)
  - SV-257852 #RHEL 9 must prevent code from being executed on file systems that contain user home directories. (1 failed)
  - SV-257857 #RHEL 9 must prevent code from being executed on file systems that are used with removable media.
  - SV-257858 #RHEL 9 must prevent special devices on file systems that are used with removable media.
  - SV-257859 #RHEL 9 must prevent files with the setuid and setgid bit set from being executed on file systems that are used with removable media.
  - SV-257862 #RHEL 9 must prevent files with the setuid and setgid bit set from being executed on the /boot/efi directory. (1 failed)
  - SV-257863 #RHEL 9 must mount /dev/shm with the nodev option. (1 failed)
  - SV-257864 #RHEL 9 must mount /dev/shm with the noexec option. (2 failed)
  - SV-257865 #RHEL 9 must mount /dev/shm with the nosuid option. (1 failed)
  - SV-257866 #RHEL 9 must mount /tmp with the nodev option. (1 failed)
  - SV-257867 #RHEL 9 must mount /tmp with the noexec option. (1 failed)
  - SV-257868 #RHEL 9 must mount /tmp with the nosuid option. (1 failed)
  - SV-257869 #RHEL 9 must mount /var with the nodev option. (1 failed)
  - SV-257870 #RHEL 9 must mount /var/log with the nodev option. (2 failed)
  - SV-257871 #RHEL 9 must mount /var/log with the noexec option. (2 failed)
  - SV-257872 #RHEL 9 must mount /var/log with the nosuid option. (2 failed)
  - SV-257873 #RHEL 9 must mount /var/log/audit with the nodev option. (2 failed)
  - SV-257874 #RHEL 9 must mount /var/log/audit with the noexec option. (2 failed)
  - SV-257875 #RHEL 9 must mount /var/log/audit with the nosuid option. (2 failed)
  - SV-257876 #RHEL 9 must mount /var/tmp with the nodev option. (2 failed)
  - SV-257877 #RHEL 9 must mount /var/tmp with the noexec option. (2 failed)
  - SV-257878 #RHEL 9 must mount /var/tmp with the nosuid option. (2 failed)
  - SV-257879 #RHEL 9 local disk partitions must implement cryptographic mechanisms to prevent unauthorized disclosure or modification of all information that requires at rest protection. (4 failed)
  - SV-257880 #RHEL 9 must disable mounting of cramfs. (2 failed)
  - SV-257881 #RHEL 9 must prevent special devices on non-root local partitions.
  - SV-257888 #RHEL 9 cron configuration directories must have a mode of 0700 or less permissive.
  - SV-257889 #All RHEL 9 local initialization files must have mode 0740 or less permissive.
  - SV-257919 #RHEL 9 system commands must be group-owned by root or a system account.
  - SV-257921 #RHEL 9 library files must be group-owned by root or a system account.
  - SV-257933 #RHEL 9 /etc/crontab file must have mode 0600. (1 failed)
  - SV-257942 #RHEL 9 must enable hardening for the Berkeley Packet Filter just-in-time compiler. (2 failed)
  - SV-257945 #RHEL 9 must securely compare internal information system clocks at least every 24 hours. (1 failed)
  - SV-257946 #RHEL 9 must disable the chrony daemon from acting as a server.
  - SV-257947 #RHEL 9 must disable network management of the chrony daemon.
  - SV-257948 #RHEL 9 systems using Domain Name Servers (DNS) resolution must have at least two name servers configured. (1 failed)
  - SV-257949 #RHEL 9 must configure a DNS processing mode set be Network Manager.
  - SV-257954 #RHEL 9 libreswan package must be installed.
  - SV-257957 #RHEL 9 must be configured to use TCP syncookies. (1 failed)
  - SV-257958 #RHEL 9 must ignore Internet Protocol version 4 (IPv4) Internet Control Message Protocol (ICMP) redirect messages. (2 failed)
  - SV-257959 #RHEL 9 must not forward Internet Protocol version 4 (IPv4) source-routed packets. (2 failed)
  - SV-257960 #RHEL 9 must log IPv4 packets with impossible addresses. (2 failed)
  - SV-257961 #RHEL 9 must log IPv4 packets with impossible addresses by default. (2 failed)
  - SV-257962 #RHEL 9 must use reverse path filtering on all IPv4 interfaces. (3 failed)
  - SV-257963 #RHEL 9 must prevent IPv4 Internet Control Message Protocol (ICMP) redirect messages from being accepted. (2 failed)
  - SV-257965 #RHEL 9 must use a reverse-path filter for IPv4 network traffic when possible by default. (1 failed)
  - SV-257966 #RHEL 9 must not respond to Internet Control Message Protocol (ICMP) echoes sent to a broadcast address. (1 failed)
  - SV-257967 #RHEL 9 must limit the number of bogus Internet Control Message Protocol (ICMP) response errors logs. (1 failed)
  - SV-257968 #RHEL 9 must not send Internet Control Message Protocol (ICMP) redirects. (2 failed)
  - SV-257969 #RHEL 9 must not allow interfaces to perform Internet Control Message Protocol (ICMP) redirects by default. (2 failed)
  - SV-257970 #RHEL 9 must not enable IPv4 packet forwarding unless the system is a router. (1 failed)
  - SV-257971 #RHEL 9 must not accept router advertisements on all IPv6 interfaces. (2 failed)
  - SV-257972 #RHEL 9 must ignore IPv6 Internet Control Message Protocol (ICMP) redirect messages. (2 failed)
  - SV-257973 #RHEL 9 must not forward IPv6 source-routed packets. (1 failed)
  - SV-257974 #RHEL 9 must not enable IPv6 packet forwarding unless the system is a router. (1 failed)
  - SV-257975 #RHEL 9 must not accept router advertisements on all IPv6 interfaces by default. (2 failed)
  - SV-257976 #RHEL 9 must prevent IPv6 Internet Control Message Protocol (ICMP) redirect messages from being accepted. (2 failed)
  - SV-257977 #RHEL 9 must not forward IPv6 source-routed packets by default. (1 failed)
  - SV-257978 #All RHEL 9 networked systems must have SSH installed.
  - SV-257981 #RHEL 9 must display the Standard Mandatory DOD Notice and Consent Banner before granting local or remote access to the system via a SSH logon.
  - SV-257987 #RHEL 9 SSH daemon must be configured to use system-wide crypto policies.
  - SV-257988 #RHEL 9 must implement DOD-approved encryption ciphers to protect the confidentiality of SSH client connections. (1 failed)
  - SV-257990 #RHEL 9 SSH client must be configured to use only Message Authentication Codes (MACs) employing FIPS 140-3 validated cryptographic hash algorithms.
  - SV-257991 #RHEL 9 SSH server must be configured to use only Message Authentication Codes (MACs) employing FIPS 140-3 validated cryptographic hash algorithms.
  - SV-257996 #RHEL 9 must be configured so that all network connections associated with SSH traffic are terminated after 10 minutes of becoming unresponsive.
  - SV-258034 #RHEL 9 must be configured to disable USB mass storage. (2 failed)
  - SV-258035 #RHEL 9 must have the USBGuard package installed.
  - SV-258036 #RHEL 9 must have the USBGuard package enabled. (2 failed)
  - SV-258038 #RHEL 9 must block unauthorized peripherals before establishing a connection. (2 failed)
  - SV-258039 #RHEL 9 Bluetooth must be disabled. (2 failed)
  - SV-258046 #RHEL 9 system accounts must not have an interactive login shell.
  - SV-258049 #RHEL 9 must disable account identifiers (individuals, groups, roles, and devices) after 35 days of inactivity. (2 failed)
  - SV-258057 #RHEL 9 must maintain an account lock until the locked account is released by an administrator.
  - SV-258058 #RHEL 9 must not have unauthorized accounts.
  - SV-258063 #RHEL 9 must have the tmux package installed.
  - SV-258064 #RHEL 9 must ensure session control is automatically started at shell initialization.
  - SV-258065 #RHEL 9 must enable a user session lock until that user re-establishes access using established identification and authentication procedures for command line sessions. (2 failed)
  - SV-258066 #RHEL 9 must automatically lock command line user sessions after 15 minutes of inactivity.
  - SV-258068 #RHEL 9 must automatically exit interactive command shell user sessions after 15 minutes of inactivity.
  - SV-258072 #RHEL 9 must define default permissions for the bash shell.
  - SV-258073 #RHEL 9 must define default permissions for the c shell.
  - SV-258075 #RHEL 9 must define default permissions for the system default profile.
  - SV-258077 #RHEL 9 must terminate idle user sessions.
  - SV-258078 #RHEL 9 must use a Linux Security Module configured to enforce limits on system services.
  - SV-258079 #RHEL 9 must enable the SELinux targeted policy. (1 failed)
  - SV-258080 #RHEL 9 must configure SELinux context type to allow the use of a nondefault faillock tally directory. (3 failed)
  - SV-258084 #RHEL 9 must require reauthentication when using the "sudo" command.
  - SV-258085 #RHEL 9 must use the invoking user's password for privilege escalation when using "sudo". (3 failed)
  - SV-258089 #RHEL 9 fapolicy module must be installed.
  - SV-258090 #RHEL 9 fapolicy module must be enabled. (2 failed)
  - SV-258091 #RHEL 9 must ensure the password complexity module in the system-auth file is configured for three retries or less.
  - SV-258092 #RHEL 9 must be configured in the password-auth file to prohibit password reuse for a minimum of five generations.
  - SV-258093 #RHEL 9 must be configured in the system-auth file to prohibit password reuse for a minimum of five generations.
  - SV-258094 #RHEL 9 must not allow blank or null passwords.
  - SV-258095 #RHEL 9 must configure the use of the pam_faillock.so module in the /etc/pam.d/system-auth file. (3 failed)
  - SV-258096 #RHEL 9 must configure the use of the pam_faillock.so module in the /etc/pam.d/password-auth file. (3 failed)
  - SV-258099 #RHEL 9 password-auth must be configured to use a sufficient number of hashing rounds.
  - SV-258100 #RHEL 9 system-auth must be configured to use a sufficient number of hashing rounds.
  - SV-258105 #RHEL 9 passwords must have a 24 hours minimum password lifetime restriction in /etc/shadow.
  - SV-258109 #RHEL 9 must enforce password complexity by requiring that at least one special character be used. (2 failed)
  - SV-258123 #RHEL 9 must implement certificate status checking for multifactor authentication.
  - SV-258131 #RHEL 9, for PKI-based authentication, must validate certificates by constructing a certification path (which includes status information) to an accepted trust anchor.
  - SV-258132 #RHEL 9 must map the authenticated identity to the user or group account for PKI-based authentication. (2 failed)
  - SV-258134 #RHEL 9 must have the AIDE package installed. (1 failed)
  - SV-258135 #RHEL 9 must routinely check the baseline configuration for unauthorized changes and notify the system administrator when anomalies in the operation of any security functions are discovered. (4 failed)
  - SV-258138 #RHEL 9 must be configured so that the file integrity tool verifies Access Control Lists (ACLs). (1 failed)
  - SV-258139 #RHEL 9 must be configured so that the file integrity tool verifies extended attributes. (1 failed)
  - SV-258141 #RHEL 9 must have the packages required for encrypting offloaded audit logs installed.
  - SV-258144 #All RHEL 9 remote access methods must be monitored. (2 failed)
  - SV-258146 #RHEL 9 must authenticate the remote logging server for offloading audit logs via rsyslog.
  - SV-258147 #RHEL 9 must encrypt the transfer of audit records offloaded onto a different system or media from the system being audited via rsyslog. (2 failed)
  - SV-258148 #RHEL 9 must encrypt via the gtls driver the transfer of audit records offloaded onto a different system or media from the system being audited via rsyslog.
  - SV-258149 #RHEL 9 must be configured to forward audit records via TCP to a different system or media from the system being audited via rsyslog.
  - SV-258155 #RHEL 9 must allocate audit record storage capacity to store at least one week's worth of audit records. (1 failed)
  - SV-258176 #RHEL 9 must audit uses of the "execve" system call.
  - SV-258177 #RHEL 9 must audit all uses of the chmod, fchmod, and fchmodat system calls. (3 failed)
  - SV-258178 #RHEL 9 must audit all uses of the chown, fchown, fchownat, and lchown system calls.
  - SV-258179 #RHEL 9 must audit all uses of the setxattr, fsetxattr, lsetxattr, removexattr, fremovexattr, and lremovexattr system calls. (6 failed)
  - SV-258187 #RHEL 9 must audit all uses of the rename, unlink, rmdir, renameat, and unlinkat system calls. (5 failed)
  - SV-258188 #RHEL 9 must audit all uses of the truncate, ftruncate, creat, open, openat, and open_by_handle_at system calls. (6 failed)
  - SV-258189 #RHEL 9 must audit all uses of the delete_module system call.
  - SV-258190 #RHEL 9 must audit all uses of the init_module and finit_module system calls. (2 failed)
  - SV-258198 #RHEL 9 must audit all uses of the passwd command.
  - SV-258216 #Successful/unsuccessful uses of the umount2 system call in RHEL 9 must generate an audit record.
  - SV-258226 #RHEL 9 must generate audit records for all account creations, modifications, disabling, and termination events that affect /var/log/tallylog.
  - SV-258229 #RHEL 9 audit system must protect auditing rules from unauthorized change.
  - SV-258230 #RHEL 9 must enable FIPS mode.
  - SV-258232 #RHEL 9 IP tunnels must use FIPS 140-2/140-3 approved cryptographic algorithms.
  - SV-258236 #RHEL 9 crypto policy must not be overridden.
  - SV-258237 #RHEL 9 must use mechanisms meeting the requirements of applicable federal laws, executive orders, directives, policies, regulations, standards, and guidance for authentication to a cryptographic module.
  - SV-258241 #RHEL 9 must implement a system-wide encryption policy.

provisioner:
  name: chef_zero
  product_name: cinc
  product_version: latest

platforms:
  - name: rhel-9

lifecycle:
  pre_create:
  - local: |
      if ! aws ec2 describe-security-groups --region us-east-1 --group-ids sg-07a2d1eb0e54c34c5 --query "SecurityGroups[0].IpPermissions" --output=text | grep -q 12345; then
        echo [INFO] Opening AWS Port 12345
        aws ec2 authorize-security-group-ingress --region us-east-1 --group-id sg-07a2d1eb0e54c34c5 --protocol tcp --port 12345 --cidr 0.0.0.0/0
      fi
  post_verify:
  - local: |
      echo [INFO] Opening Heimdall Lite
      kitchen exec -c 'less -F /tmp/heimdall-lite.sh' > spec/results/heimdall-lite.sh #| tail -n +2 | bash 2>/dev/null

  #post_converge:
  #- local: |
  #    curl -# -s -F data=@spec/results/rhel-9_default.json -F "filename=rhel-9_default.json" -F "public=true" -F "evaluationTags=8438b61,mitre/redhat-enterprise-linux-8-stig-baseline,#DISA Hardened EC2 Testing Matrix,'Supplemental Automation Content v1r12'" -H "Authorization: Api-Key 96d836e4f661fdae4aed5da854af5cc44df77d31401e8554e8b52ea45575cdf05a" "https://heimdall-demo.mitre.org/evaluations"