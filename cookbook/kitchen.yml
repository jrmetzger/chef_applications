---
driver:
  name: vagrant

#driver_config:
#  network:
#  - [
#      "forwarded_port", {
#        guest: 12345, # May Need to Change This
#        host: 12345 # DO NOT CHANGE THIS. MUST MATCH WHAT IS IN ATTRIBUTES
#      }
#    ]

verifier:
  name: inspec
  sudo: true
  reporter:
    - cli
    - json:spec/results/%{platform}_%{suite}.json

provisioner:
  name: chef_zero
  product_name: cinc
  product_version: latest

# https://portal.cloud.hashicorp.com/vagrant/discover
platforms:

  # Redhat 8
  - name: rhel8
    driver:
      box: generic/rhel8
    verifier:
      inspec_tests:
      - name: rhel8
        git: https://github.com/mitre/redhat-enterprise-linux-8-stig-baseline.git

  # Redhat 9
  - name: rhel9
    driver:
      box: generic/rhel9
    verifier:
      inspec_tests:
      - name: rhel9
        git: https://github.com/mitre/redhat-enterprise-linux-9-stig-baseline.git
      controls:
      - SV-257777 # RHEL 9 must be a vendor-supported release.
      - SV-257778 # RHEL 9 vendor packaged system security patches and updates must be installed and up to date. (1248 failed)
      - SV-257779 # RHEL 9 must display the Standard Mandatory DOD Notice and Consent Banner before granting local or remote access to the system via a command line user logon. (1 failed)
      - SV-257780 # RHEL 9 must implement the Endpoint Security for Linux Threat Prevention tool. (2 failed)
      - SV-257784 # The systemd Ctrl-Alt-Delete burst key sequence in RHEL 9 must be disabled.
      - SV-257789 # RHEL 9 must require a unique superusers name upon booting into single-user and maintenance modes. (1 failed)
      - SV-257803 # RHEL 9 must disable the kernel.core_pattern. (3 failed)
      - SV-257811 # RHEL 9 must restrict usage of ptrace to descendant processes. (1 failed)
      - SV-257814 # RHEL 9 must disable core dumps for all users. (1 failed)
      - SV-257817 # RHEL 9 must implement nonexecutable data to protect its memory from unauthorized code execution.
      - SV-257818 # The kdump service on RHEL 9 must be disabled. (2 failed)
      - SV-257823 # RHEL 9 must be configured so that the cryptographic hashes of system files match vendor values.
      - SV-257839 # RHEL 9 must have the gnutls-utils package installed.
      - SV-257843 # A separate RHEL 9 file system must be used for user home directories (such as /home or an equivalent). (1 failed)
      - SV-257850 # RHEL 9 must prevent device files from being interpreted on file systems that contain user home directories. (1 failed)
      - SV-257851 # RHEL 9 must prevent files with the setuid and setgid bit set from being executed on file systems that contain user home directories. (1 failed)
      - SV-257852 # RHEL 9 must prevent code from being executed on file systems that contain user home directories. (1 failed)
      - SV-257857 # RHEL 9 must prevent code from being executed on file systems that are used with removable media.
      - SV-257858 # RHEL 9 must prevent special devices on file systems that are used with removable media.
      - SV-257859 # RHEL 9 must prevent files with the setuid and setgid bit set from being executed on file systems that are used with removable media.
      - SV-257862 # RHEL 9 must prevent files with the setuid and setgid bit set from being executed on the /boot/efi directory. (1 failed)
      - SV-257866 # RHEL 9 must mount /tmp with the nodev option. (2 failed)
      - SV-257869 # RHEL 9 must mount /var with the nodev option. (2 failed)
      - SV-257879 # RHEL 9 local disk partitions must implement cryptographic mechanisms to prevent unauthorized disclosure or modification of all information that requires at rest protection. (10 failed)
      - SV-257880 # RHEL 9 must disable mounting of cramfs. (2 failed)
      - SV-257881 # RHEL 9 must prevent special devices on non-root local partitions.
      - SV-257888 # RHEL 9 cron configuration directories must have a mode of 0700 or less permissive.
      - SV-257889 # All RHEL 9 local initialization files must have mode 0740 or less permissive.
      - SV-257919 # RHEL 9 system commands must be group-owned by root or a system account.
      - SV-257921 # RHEL 9 library files must be group-owned by root or a system account.
      - SV-257933 # RHEL 9 /etc/crontab file must have mode 0600. (1 failed)
      - SV-257936 # The firewalld service on RHEL 9 must be active. (1 failed)
      - SV-257937 # A RHEL 9 firewall must employ a deny-all, allow-by-exception policy for allowing connections to other systems. (1 failed)
      - SV-257938 # RHEL 9 must control remote access methods. (3 failed)
      - SV-257940 # RHEL 9 must be configured to prohibit or restrict the use of functions, ports, protocols, and/or services, as defined in the Ports, Protocols, and Services Management (PPSM) Category Assignments List (CAL) and vulnerability assessments. (4 failed)
      - SV-257944 # RHEL 9 chronyd service must be enabled. (1 failed)
      - SV-257945 # RHEL 9 must securely compare internal information system clocks at least every 24 hours.
      - SV-257948 # RHEL 9 systems using Domain Name Servers (DNS) resolution must have at least two name servers configured. (1 failed)
      - SV-257949 # RHEL 9 must configure a DNS processing mode set be Network Manager.
      - SV-257957 # RHEL 9 must be configured to use TCP syncookies. (3 failed)
      - SV-257959 # RHEL 9 must not forward Internet Protocol version 4 (IPv4) source-routed packets. (1 failed)
      - SV-257962 # RHEL 9 must use reverse path filtering on all IPv4 interfaces. (1 failed)
      - SV-257965 # RHEL 9 must use a reverse-path filter for IPv4 network traffic when possible by default. (1 failed)
      - SV-257978 # All RHEL 9 networked systems must have SSH installed.
      - SV-257981 # RHEL 9 must display the Standard Mandatory DOD Notice and Consent Banner before granting local or remote access to the system via a SSH logon.
      - SV-257985 # RHEL 9 must not permit direct logons to the root account using remote access via SSH.
      - SV-257986 # RHEL 9 must enable the Pluggable Authentication Module (PAM) interface for SSHD.
      - SV-257987 # RHEL 9 SSH daemon must be configured to use system-wide crypto policies.
      - SV-257988 # RHEL 9 must implement DOD-approved encryption ciphers to protect the confidentiality of SSH client connections. (1 failed)
      - SV-257990 # RHEL 9 SSH client must be configured to use only Message Authentication Codes (MACs) employing FIPS 140-3 validated cryptographic hash algorithms.
      - SV-257991 # RHEL 9 SSH server must be configured to use only Message Authentication Codes (MACs) employing FIPS 140-3 validated cryptographic hash algorithms.
      - SV-257996 # RHEL 9 must be configured so that all network connections associated with SSH traffic are terminated after 10 minutes of becoming unresponsive.
      - SV-258010 # RHEL 9 SSH daemon must be configured to use privilege separation.
      - SV-258034 # RHEL 9 must be configured to disable USB mass storage. (2 failed)
      - SV-258036 # RHEL 9 must have the USBGuard package enabled. (2 failed)
      - SV-258037 # RHEL 9 must enable Linux audit logging for the USBGuard daemon.
      - SV-258038 # RHEL 9 must block unauthorized peripherals before establishing a connection. (2 failed)
      - SV-258058 # RHEL 9 must not have unauthorized accounts.
      - SV-258060 # RHEL 9 must ensure account lockouts persist.
      - SV-258064 # RHEL 9 must ensure session control is automatically started at shell initialization.
      - SV-258065 # RHEL 9 must enable a user session lock until that user re-establishes access using established identification and authentication procedures for command line sessions. (2 failed)
      - SV-258066 # RHEL 9 must automatically lock command line user sessions after 15 minutes of inactivity.
      - SV-258067 # RHEL 9 must prevent users from disabling session control mechanisms.
      - SV-258068 # RHEL 9 must automatically exit interactive command shell user sessions after 15 minutes of inactivity.
      - SV-258072 # RHEL 9 must define default permissions for the bash shell.
      - SV-258073 # RHEL 9 must define default permissions for the c shell.
      - SV-258075 # RHEL 9 must define default permissions for the system default profile.
      - SV-258077 # RHEL 9 must terminate idle user sessions.
      - SV-258080 # RHEL 9 must configure SELinux context type to allow the use of a nondefault faillock tally directory. (2 failed)
      - SV-258084 # RHEL 9 must require reauthentication when using the "sudo" command.
      - SV-258085 # RHEL 9 must use the invoking user's password for privilege escalation when using "sudo". (3 failed)
      - SV-258090 # RHEL 9 fapolicy module must be enabled. (2 failed)
      - SV-258091 # RHEL 9 must ensure the password complexity module in the system-auth file is configured for three retries or less.
      - SV-258092 # RHEL 9 must be configured in the password-auth file to prohibit password reuse for a minimum of five generations.
      - SV-258093 # RHEL 9 must be configured in the system-auth file to prohibit password reuse for a minimum of five generations.
      - SV-258094 # RHEL 9 must not allow blank or null passwords.
      - SV-258095 # RHEL 9 must configure the use of the pam_faillock.so module in the /etc/pam.d/system-auth file. (3 failed)
      - SV-258096 # RHEL 9 must configure the use of the pam_faillock.so module in the /etc/pam.d/password-auth file. (3 failed)
      - SV-258099 # RHEL 9 password-auth must be configured to use a sufficient number of hashing rounds.
      - SV-258100 # RHEL 9 system-auth must be configured to use a sufficient number of hashing rounds.
      - SV-258105 # RHEL 9 passwords must have a 24 hours minimum password lifetime restriction in /etc/shadow.
      - SV-258123 # RHEL 9 must implement certificate status checking for multifactor authentication.
      - SV-258131 # RHEL 9, for PKI-based authentication, must validate certificates by constructing a certification path (which includes status information) to an accepted trust anchor. (2 failed)
      - SV-258132 # RHEL 9 must map the authenticated identity to the user or group account for PKI-based authentication. (2 failed)
      - SV-258134 # RHEL 9 must have the AIDE package installed. (1 failed)
      - SV-258137 # RHEL 9 must use cryptographic mechanisms to protect the integrity of audit tools. (10 failed)
      - SV-258139 # RHEL 9 must be configured so that the file integrity tool verifies extended attributes. (1 failed)
      - SV-258142 # The rsyslog service on RHEL 9 must be active. (1 failed)
      - SV-258149 # RHEL 9 must be configured to forward audit records via TCP to a different system or media from the system being audited via rsyslog.
      - SV-258152 # RHEL 9 audit service must be enabled. (1 failed)
      - SV-258235 # RHEL 9 crypto policy files must match files shipped with the operating system.
      - SV-258236 # RHEL 9 crypto policy must not be overridden.
      - SV-258237 # RHEL 9 must use mechanisms meeting the requirements of applicable federal laws, executive orders, directives, policies, regulations, standards, and guidance for authentication to a cryptographic module.
      - SV-258241 # RHEL 9 must implement a system-wide encryption policy.
      input_files:
      - compliance/inputs/rhel9_stig.yml
      waiver_files:
      - compliance/waivers/rhel9_stig.yml
      - compliance/waivers/stig_reboot.yml
  - name: bduguid/amazonlinux-2
  - name: amazonlinux-2023
    driver:
      box: bduguid/amazonlinux-2023
  - name: ubuntu20
    driver:
      box:  bento/ubuntu-20.04
  - name: ubuntu22
    driver:
      box: bento/ubuntu-22.04
  #- name:bento/ubuntu-24.04

suites:
  - name: default
    includes:
    - rhel8
    - rhel9
    - amazonlinux2023
    - ubuntu22

lifecycle:
  # pre_destroy:
  # - local: |
  # for i in $(vagrant global-status | awk '{print $1}' | grep ${KITCHEN_INSTANCE_NAME}); do vagrant destroy -f $i 2>/dev/null; done
  # for i in $(vagrant global-status | awk '{print $1}'); do vagrant destroy -f $i 2>/dev/null; done
  post_destroy:
  - local: |
      echo "[INFO] Closing Port 12345"
      #kill -9 $(lsof -i :12345 -t)
      echo "[INFO] Killing Virtual Box VM"
      VBoxManage unregistervm "$(VBoxManage list vms | grep ${KITCHEN_INSTANCE_NAME} | awk -F'[{}]' '{print $2}')" --delete
      echo "[INFO] Pruning Vagrant"
      vagrant global-status --prune
      #vagrant reload
      # vagrant destroy -f
  post_create:
  - local: |
      echo [INFO] Setting up Keys Area...
      mkdir -m 700 -p .keys
      rm -f .keys/${KITCHEN_INSTANCE_NAME}_fips_key
      echo "[INFO] Generating FIPS Key..."
      ssh-keygen -t rsa -b 4096 -f .keys/${KITCHEN_INSTANCE_NAME}_fips_key -o -a 100 -N "" -C "stig_test_kitchen" >/dev/null 2>&1
      chmod g-rwx,o-rwx .keys/*
      echo "[INFO] Updating Pub Key to use FIPS Key Authorization..."
      kitchen exec ${KITCHEN_INSTANCE_NAME} -c "echo $(cat .keys/${KITCHEN_INSTANCE_NAME}_fips_key.pub) >> ~/.ssh/authorized_keys"
      echo "[INFO] Updating Priv Key to use FIPS Key Credentials..."
      #yq eval ".ssh_key = \".keys/${KITCHEN_INSTANCE_NAME}_fips_key\"" -i .kitchen/${KITCHEN_INSTANCE_NAME}.yml
  - remote: |
      echo "[INFO] Attempting Red Hat subscription registration..."
      sudo -i subscription-manager register --username "<%= ENV['REDHAT_USERNAME'] %>" --password "<%= ENV['REDHAT_PASSWORD'] %>" --force || echo "[CRIT] Registration failed"
      echo "[INFO] Updating Packages..."
      #sudo -i yum -y update || echo "[WARN] Failed to update packages"
      #dnf -y update --quiet --progressbar=plain #tty
      echo "[INFO] Stopping Insights Client"
      #sudo systemctl stop insights-client
