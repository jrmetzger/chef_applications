---
# https://us-east-1.console.aws.amazon.com/ec2/home?region=us-east-1#Home:
suites:
  - name: default
    transport:
      ssh_key: keys/jon_test.pem
      username: ec2-user
    driver:
      name: ec2
      region: us-east-1
      instance_type: t3.micro
      associate_public_ip: true
      # https://us-east-1.console.aws.amazon.com/ec2/home?region=us-east-1#KeyPairs:
      aws_ssh_key_id: jon_test
      # https://us-east-1.console.aws.amazon.com/ec2/home?region=us-east-1#SecurityGroups:
      security_group_ids: ['sg-07a2d1eb0e54c34c5']
      # https://us-east-1.console.aws.amazon.com/vpcconsole/home?region=us-east-1#subnets:
      subnet_id: subnet-09b5e80a62cfe2253
      # https://us-east-1.console.aws.amazon.com/ec2/home?region=us-east-1#AMICatalog:
      image_id: ami-0b112ae24c8e415a5

verifier:
  name: inspec
  sudo: true
  reporter:
    - cli
    - json:spec/results/%{platform}_%{suite}.json
  inspec_tests:
    - name: rhel9
      git: https://github.com/mitre/redhat-enterprise-linux-9-stig-baseline.git

provisioner:
  name: chef_zero
  product_name: cinc
  product_version: latest

platforms:
  - name: rhel-9

lifecycle:
  pre_create:
  - local: |
      if ! aws ec2 describe-security-groups --region us-east-1 --group-ids sg-07a2d1eb0e54c34c5 --query "SecurityGroups[0].IpPermissions" --output=text | grep -q 12345; then
        echo [INFO] Opening AWS Port 12345
        aws ec2 authorize-security-group-ingress --region us-east-1 --group-id sg-07a2d1eb0e54c34c5 --protocol tcp --port 12345 --cidr 0.0.0.0/0
      fi
  #post_converge:
  #- local: |
  #    curl -# -s -F data=@spec/results/rhel-9_default.json -F "filename=rhel-9_default.json" -F "public=true" -F "evaluationTags=8438b61,mitre/redhat-enterprise-linux-8-stig-baseline,#DISA Hardened EC2 Testing Matrix,'Supplemental Automation Content v1r12'" -H "Authorization: Api-Key 96d836e4f661fdae4aed5da854af5cc44df77d31401e8554e8b52ea45575cdf05a" "https://heimdall-demo.mitre.org/evaluations"